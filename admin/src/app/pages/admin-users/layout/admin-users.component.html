<div class="admin-users">
	<form
		[formGroup]="emailSubmissionForm"
		(ngSubmit)="sendList()"
		class="email-submission-form">
		<input b2bNgxInput placeholder="Enter email" formControlName="email"/>
		<button
			b2bNgxButton
			[disabled]="emailSubmissionForm.invalid"
			[theme]="b2bNgxButtonThemeEnum.BACKGROUND_BLACK"
			class="admin-offers__button">
			Send list
		</button>
	</form>

	<button
		b2bNgxButton
		[theme]="b2bNgxButtonThemeEnum.BACKGROUND_BLACK"
		(click)="export()"
		class="admin-offers__button">
		Export
	</button>

	<b2b-admin-users-filters
		[categories]="categories"
		[formControl]="filtersControl">
	</b2b-admin-users-filters>

	<div class="admin-users__table">
		<table mat-table
					 [dataSource]="users$ | async" multiTemplateDataRows
					 class="mat-elevation-z8">
			<ng-container matColumnDef="expand">
				<th mat-header-cell *matHeaderCellDef aria-label="row actions">&nbsp;</th>
				<td mat-cell *matCellDef="let element">
					<button mat-icon-button aria-label="expand row"
									(click)="(expandedElement = expandedElement === element ? null : element); $event.stopPropagation()">
						@if (expandedElement === element) {
							<mat-icon>keyboard_arrow_up</mat-icon>
						} @else {
							<mat-icon>keyboard_arrow_down</mat-icon>
						}
					</button>
				</td>
			</ng-container>

			@for (column of columnsToDisplay; track column; let i = $index) {
				<ng-container matColumnDef="{{column}}">
					<th mat-header-cell *matHeaderCellDef class="pt-2 pb-2"> {{ displayNames[i] }}</th>
					<td mat-cell *matCellDef="let element" (click)="onClick(column, element)">
						@if (column === 'createdAt') {
							<span>{{ element[column] | date: 'yyyy-MM-dd' }}</span>
						} @else if (column === 'actions') {
							<button
								b2bNgxButton
								[theme]="b2bNgxButtonThemeEnum.BACKGROUND_BLACK"
								[matMenuTriggerFor]="menu"
								(click)="$event.stopImmediatePropagation()"
								class="admin-offers__button">
								Delete
							</button>

							<mat-menu #menu="matMenu">
								<button mat-menu-item (click)="deleteUser(element._id, false)">Delete</button>
								<button mat-menu-item (click)="deleteUser(element._id, true)">Permanent delete</button>
							</mat-menu>
						} @else {
							<span>{{ element[column] }}</span>
						}
					</td>
				</ng-container>
			}

			<ng-container matColumnDef="expandedDetail">
				<td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplayWithExpand.length">
					<div class="detail"
							 [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
						@if (element?.['offers']?.length > 0) {
							<div class="d-flex pt-2 pb-2 gap-2">
								<p class="fw-bolder">Placed offers:</p>

								<div class="d-flex flex-wrap gap-2">
									@for (item of element?.['offers']; track item.title) {
										<div>
											<span>{{ item.title }}</span> -
											<span>{{ item.date | date: 'yyyy-mm-dd' }}</span>
											<span class="fw-bold"> | [ {{ item.reasonForDeletion }} ]</span>,
										</div>
									}
								</div>
							</div>
						}

						@if (element?.['category__1']?.length > 0) {
							<div class="d-flex pt-2 pb-2 gap-2">
								<p class="fw-bolder">Product sectors:</p>

								<div class="d-flex flex-wrap gap-2">
									@for (item of element?.['category__1']; track item.title) {
										<div>
											<span>{{ item.name }},</span>
										</div>
									}
								</div>
							</div>
						}

						@if (element?.['category__2']?.length > 0) {
							<div class="d-flex pt-2 pb-2 gap-2">
								<p class="fw-bolder">Product categories:</p>

								<div class="d-flex flex-wrap gap-2">
									@for (item of element?.['category__2']; track item.title) {
										<div>
											<span>{{ item.name }},</span>
										</div>
									}
								</div>
							</div>
						}
					</div>
				</td>
			</ng-container>

			<tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
			<tr mat-row *matRowDef="let element; columns: columnsToDisplayWithExpand;"
					class="example-element-row"
					[class.example-expanded-row]="expandedElement === element"
					(click)="$event.stopPropagation()">
			</tr>
			<tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail"></tr>
		</table>
	</div>

	<b2b-pagination
		class="pb-2"
		[length]="totalCount"
		[perPage]="10"
		(togglePageNumber)="setPage($event)"></b2b-pagination>
</div>
